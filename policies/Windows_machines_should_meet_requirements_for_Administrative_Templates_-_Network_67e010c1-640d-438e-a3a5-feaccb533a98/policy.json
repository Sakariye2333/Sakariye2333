{
 "properties": {
  "displayName": "Windows machines should meet requirements for 'Administrative Templates - Network'",
  "policyType": "BuiltIn",
  "mode": "Indexed",
  "description": "Windows machines should have the specified Group Policy settings in the category 'Administrative Templates - Network' for guest logons, simultaneous connections, network bridge, ICS, and multicast name resolution. This policy requires that the Guest Configuration prerequisites have been deployed to the policy assignment scope. For details, visit https://aka.ms/gcpol.",
  "metadata": {
   "category": "Guest Configuration",
   "version": "2.0.0",
   "requiredProviders": [
    "Microsoft.GuestConfiguration"
   ],
   "guestConfiguration": {
    "name": "AzureBaseline_AdministrativeTemplatesNetwork",
    "version": "1.*",
    "configurationParameter": {
     "EnableInsecureGuestLogons": "Enable insecure guest logons;ExpectedValue",
     "AllowSimultaneousConnectionsToTheInternetOrAWindowsDomain": "Minimize the number of simultaneous connections to the Internet or a Windows Domain;ExpectedValue",
     "TurnOffMulticastNameResolution": "Turn off multicast name resolution;ExpectedValue"
    }
   }
  },
  "parameters": {
   "IncludeArcMachines": {
    "type": "String",
    "metadata": {
     "displayName": "Include Arc connected servers",
     "description": "By selecting this option, you agree to be charged monthly per Arc connected machine."
    },
    "allowedValues": [
     "true",
     "false"
    ],
    "defaultValue": "false"
   },
   "EnableInsecureGuestLogons": {
    "type": "String",
    "metadata": {
     "displayName": "Enable insecure guest logons",
     "description": "Specifies whether the SMB client will allow insecure guest logons to an SMB server."
    },
    "defaultValue": "0"
   },
   "AllowSimultaneousConnectionsToTheInternetOrAWindowsDomain": {
    "type": "String",
    "metadata": {
     "displayName": "Allow simultaneous connections to the Internet or a Windows Domain",
     "description": "Specify whether to prevent computers from connecting to both a domain based network and a non-domain based network at the same time. A value of 0 allows simultaneous connections, and a value of 1 blocks them."
    },
    "defaultValue": "1"
   },
   "TurnOffMulticastNameResolution": {
    "type": "String",
    "metadata": {
     "displayName": "Turn off multicast name resolution",
     "description": "Specifies whether LLMNR, a secondary name resolution protocol that transmits using multicast over a local subnet link on a single subnet, is enabled."
    },
    "defaultValue": "1"
   },
   "effect": {
    "type": "String",
    "metadata": {
     "displayName": "Effect",
     "description": "Enable or disable the execution of this policy"
    },
    "allowedValues": [
     "AuditIfNotExists",
     "Disabled"
    ],
    "defaultValue": "AuditIfNotExists"
   }
  },
  "policyRule": {
   "if": {
    "anyOf": [
     {
      "allOf": [
       {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
       },
       {
        "anyOf": [
         {
          "field": "Microsoft.Compute/imagePublisher",
          "in": [
           "esri",
           "incredibuild",
           "MicrosoftDynamicsAX",
           "MicrosoftSharepoint",
           "MicrosoftVisualStudio",
           "MicrosoftWindowsDesktop",
           "MicrosoftWindowsServerHPCPack"
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "MicrosoftWindowsServer"
           },
           {
            "field": "Microsoft.Compute/imageSKU",
            "notLike": "2008*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "MicrosoftSQLServer"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "notLike": "SQL2008*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoft-dsvm"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "equals": "dsvm-windows"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoft-ads"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "in": [
             "standard-data-science-vm",
             "windows-data-science-vm"
            ]
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "batch"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "equals": "rendering-windows2016"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "center-for-internet-security-inc"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "cis-windows-server-201*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "pivotal"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "bosh-windows-server*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "cloud-infrastructure-services"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "ad*"
           }
          ]
         },
         {
          "allOf": [
           {
            "anyOf": [
             {
              "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration",
              "exists": "true"
             },
             {
              "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
              "like": "Windows*"
             }
            ]
           },
           {
            "anyOf": [
             {
              "field": "Microsoft.Compute/imageSKU",
              "exists": "false"
             },
             {
              "allOf": [
               {
                "field": "Microsoft.Compute/imageSKU",
                "notLike": "2008*"
               },
               {
                "field": "Microsoft.Compute/imageOffer",
                "notLike": "SQL2008*"
               }
              ]
             }
            ]
           }
          ]
         }
        ]
       }
      ]
     },
     {
      "allOf": [
       {
        "value": "[parameters('IncludeArcMachines')]",
        "equals": "true"
       },
       {
        "field": "type",
        "equals": "Microsoft.HybridCompute/machines"
       },
       {
        "field": "Microsoft.HybridCompute/imageOffer",
        "like": "windows*"
       }
      ]
     }
    ]
   },
   "then": {
    "effect": "[parameters('effect')]",
    "details": {
     "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
     "name": "AzureBaseline_AdministrativeTemplatesNetwork",
     "existenceCondition": {
      "allOf": [
       {
        "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/complianceStatus",
        "equals": "Compliant"
       },
       {
        "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
        "equals": "[base64(concat('Enable insecure guest logons;ExpectedValue', '=', parameters('EnableInsecureGuestLogons'), ',', 'Minimize the number of simultaneous connections to the Internet or a Windows Domain;ExpectedValue', '=', parameters('AllowSimultaneousConnectionsToTheInternetOrAWindowsDomain'), ',', 'Turn off multicast name resolution;ExpectedValue', '=', parameters('TurnOffMulticastNameResolution')))]"
       }
      ]
     }
    }
   }
  }
 },
 "id": "/providers/Microsoft.Authorization/policyDefinitions/67e010c1-640d-438e-a3a5-feaccb533a98",
 "type": "Microsoft.Authorization/policyDefinitions",
 "name": "67e010c1-640d-438e-a3a5-feaccb533a98"
}